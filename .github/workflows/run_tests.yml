name: Run Tests

run-name: >
    Tests Execution â€“ ${{ github.event.pull_request.title || github.event.head_commit.message }}
    (#${{ github.event.pull_request.number || github.run_number }})

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    test:
        name: Tests Exectuion
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Environment
              uses: ./.github/actions/setup-env

            - name: Get Playwright version
              id: playwright-version
              shell: bash
              run: echo "version=$(uv run pip show playwright | grep Version | cut -d' ' -f2)" >> $GITHUB_OUTPUT

            - name: Cache Playwright Browsers
              id: cache-playwright
              uses: actions/cache@v4
              with:
                  path: ~/.cache/ms-playwright
                  key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}
            - name: Install Playwright Browsers (only if not cached)
              if: steps.cache-playwright.outputs.cache-hit != 'true'
              run: uv run playwright install chromium --with-deps

            - name: Install Playwright Dependencies (always needed)
              if: steps.cache-playwright.outputs.cache-hit == 'true'
              run: uv run playwright install-deps chromium

            - name: Execute tests
              run: uv run pytest --browser chromium --all-mobile-devices --video on -n auto
